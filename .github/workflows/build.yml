name: Build

on:
  push:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version for RPM build'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"
      - name: Set version
        run: |
          export VERSION=${{ steps.previoustag.outputs.tag }}
      - name: Setup tools
        run: sudo apt-get install pandoc
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Build
        run: VERSION="${{ steps.previoustag.outputs.tag }}" make all

  build-rpm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      VERSION: ${{ steps.determine_version.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
      - name: Determine version
        id: determine_version
        run: |
          # For manual runs we allow an explicit version input, otherwise use the ref name
          INPUT_VERSION="${{ github.event.inputs.version }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "$INPUT_VERSION" ]; then
            VERSION="$INPUT_VERSION"
          else
            VERSION="${{ github.ref_name }}"
          fi
          # strip any leading v
          VERSION="${VERSION#v}"
          # Sanitize version for RPM: replace any character not in [A-Za-z0-9._] with an underscore.
          SANITIZED_VERSION="${VERSION//[^A-Za-z0-9._]/_}"
          # Ensure we have a non-empty version for rpmbuild
          if [ -z "$SANITIZED_VERSION" ]; then
            SANITIZED_VERSION="0"
          fi
          echo "Resolved RPM version (sanitized)=${SANITIZED_VERSION}"
          echo "VERSION=${SANITIZED_VERSION}" >> $GITHUB_OUTPUT
      - name: Setup tools
        run: sudo apt-get install pandoc rpm
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - name: Build RPM
        run: |
          echo "Building RPM with version ${{ steps.determine_version.outputs.VERSION }}"
          # The actual RPM build would happen here when Makefile and spec are ready
          # VERSION="${{ steps.determine_version.outputs.VERSION }}" make rpm
