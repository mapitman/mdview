name: Release

on:
  push:
    tags:
      - '*'

jobs:
  build-binaries:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get tag version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          # Remove leading 'v' if present
          VERSION="${VERSION#v}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Setup tools
        run: sudo apt-get install -y pandoc

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build all binaries
        run: VERSION=${{ steps.version.outputs.VERSION }} make all deb

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: |
            mdview-*.tar.gz
            mdview-*.zip
            mdview_*.deb

  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            rpm-build \
            golang \
            pandoc \
            make \
            git \
            tar \
            gzip

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get tag version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build RPM package
        run: VERSION=${{ steps.version.outputs.VERSION }} make rpm

      - name: Copy RPMs to workspace
        run: |
          mkdir -p dist
          cp ${HOME}/rpmbuild/RPMS/x86_64/mdview-*.x86_64.rpm dist/ || true
          cp ${HOME}/rpmbuild/SRPMS/mdview-*.src.rpm dist/ || true
          ls -lh dist/

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages
          path: dist/mdview-*.rpm

  release:
    needs: [build-binaries, build-rpm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get tag version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: Prepare release files
        run: |
          mkdir -p release
          cp release-files/binaries/* release/ || true
          cp release-files/rpm-packages/* release/ || true
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}